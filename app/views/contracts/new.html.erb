<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-light py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-file-contract me-2"></i>Yeni Kontrat
        </h5>
        <%= link_to contracts_path, class: "btn btn-sm btn-outline-secondary" do %>
          <i class="fas fa-arrow-left me-1"></i>Geri
        <% end %>
      </div>
    </div>

    <div class="card-body">
      <%= form_with model: @contract, local: true, class: "needs-validation" do |f| %>
        <div class="row g-3">
          <!-- Müşteri ve Vinç Seçimi -->
          <div class="col-md-6">
            <div class="form-floating mb-3">
              <%= f.collection_select :customer_id, @customers, :id, :customer_name,
                  { prompt: "Müşteri Seçin" },
                  { class: "form-select", required: true } %>
              <%= f.label :customer_id, "Müşteri" %>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating mb-3">
              <%= f.collection_select :crane_id, @cranes, :id,
                  ->(crane) { "#{crane.crane_brand_name} - #{crane.crane_chassis_no}" },
                  { prompt: "Vinç Seçin" },
                  { class: "form-select", required: true } %>
              <%= f.label :crane_id, "Vinç" %>
            </div>
          </div>

          <!-- Kiralama Detayları -->
          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.number_field :rent_term,
                  class: "form-control",
                  id: "rent_term",
                  min: 1,
                  required: true %>
              <%= f.label :rent_term, "Kiralama Süresi (Ay)" %>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.number_field :rent_amount,
                  class: "form-control",
                  min: 0,
                  step: "0.01",
                  required: true %>
              <%= f.label :rent_amount, "Fiyat (₺)" %>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.number_field :vat_percentage,
                  class: "form-control",
                  min: 0,
                  max: 100,
                  value: 20 %>
              <%= f.label :vat_percentage, "KDV Oranı (%)" %>
            </div>
          </div>

          <!-- Tarih Bilgileri -->
          <div class="col-12">
            <hr class="text-muted">
          </div>

          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.date_field :contract_date,
                  class: "form-control",
                  value: Date.current,
                  required: true %>
              <%= f.label :contract_date, "Kontrat Tarihi" %>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.date_field :rent_start_date,
                  class: "form-control",
                  id: "rent_start_date",
                  value: Date.current,
                  required: true %>
              <%= f.label :rent_start_date, "Başlangıç Tarihi" %>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating mb-3">
              <%= f.date_field :rent_finish_date,
                  class: "form-control",
                  id: "rent_finish_date",
                  readonly: true %>
              <%= f.label :rent_finish_date, "Bitiş Tarihi" %>
            </div>
          </div>

          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-sticky-note me-2"></i>Genel Not
                </h6>
              </div>
              <div class="card-body">
                <div class="form-floating">
                  <%= f.text_area :contract_note,
                      class: "form-control",
                      style: "height: 120px",
                      placeholder: "Genel Not" %>
                  <%= f.label :contract_note do %>
                    <i class="fas fa-pencil-alt me-1"></i>Not
                  <% end %>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Butonları -->
          <div class="col-12 mt-4">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <%= link_to contracts_path, class: "btn btn-outline-secondary me-2" do %>
                <i class="fas fa-times me-1"></i>İptal
              <% end %>
              <%= button_tag type: 'submit', class: "btn btn-primary" do %>
                <i class="fas fa-save me-1"></i>Kaydet
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :head do %>
  <style>
    .form-floating > .form-select {
      padding-top: 1.625rem;
      padding-bottom: 0.625rem;
    }
  </style>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const rentTermInput = document.getElementById('rent_term');
  const startDateInput = document.getElementById('rent_start_date');
  const finishDateInput = document.getElementById('rent_finish_date');

  function updateFinishDate() {
    const rentTerm = parseInt(rentTermInput.value) || 0;
    const startDate = new Date(startDateInput.value);
    
    if (rentTerm > 0 && startDate instanceof Date && !isNaN(startDate)) {
      const finishDate = new Date(startDate);
      finishDate.setMonth(finishDate.getMonth() + rentTerm);
      
      const year = finishDate.getFullYear();
      const month = String(finishDate.getMonth() + 1).padStart(2, '0');
      const day = String(finishDate.getDate()).padStart(2, '0');
      
      finishDateInput.value = `${year}-${month}-${day}`;
    }
  }

  rentTermInput.addEventListener('input', updateFinishDate);
  startDateInput.addEventListener('change', updateFinishDate);
});
</script>