<div class="card-header d-flex justify-content-between align-items-center">
  <h1 class="card-title mb-4">Kontrat Detayları</h1>
  <div class="d-flex gap-2">
    <%= link_to 'PDF OLUŞTUR', show_pdf_contract_path(@contract), target: "_blank", class: "btn btn-sm btn-outline-info mx-1" %>
  </div>
</div>
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100 border-0 bg-light">
          <div class="card-body">
            <h5 class="card-title mb-3">Müşteri ve Sözleşme Bilgileri</h5>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Kiralayan:</span>
              <strong><%= @contract.customer.customer_name %></strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Kiralama Süresi:</span>
              <strong><%= @contract.rent_term %> ay</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Toplam Tutar:</span>
              <strong class="text-primary"><%= number_to_currency(@contract.rent_amount) %></strong>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card h-100 border-0 bg-light">
          <div class="card-body">
            <h5 class="card-title mb-3">Vinç Teknik Özellikleri</h5>
            <div class="row">
              <div class="col-6">
                <div class="mb-2">
                  <small class="text-muted d-block">Marka</small>
                  <strong><%= @contract.crane.crane_brand_name %></strong>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">Seri No</small>
                  <strong><%= @contract.crane.crane_chassis_no %></strong>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">İmal Yılı</small>
                  <strong><%= @contract.crane.crane_year %></strong>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">Maks. Kapasite</small>
                  <strong><%= @contract.crane.crane_tonnage %> KG</strong>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-2">
                  <small class="text-muted d-block">Yükseklik</small>
                  <strong><%= @contract.crane.crane_height %> MT</strong>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">Bom Uzunluğu</small>
                  <strong><%= @contract.crane.crane_boom_length %> MT</strong>
                </div>
                <div class="mb-2">
                  <small class="text-muted d-block">Bom Ucu Tonajı</small>
                  <strong><%= @contract.crane.crane_boom_tonnage %> KG</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<h2>Ödeme Tablosu</h2>
<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th scope="col">S.No</th>
      <th scope="col" class="text-center align-middle">Adet</th>
      <th scope="col" class="text-center align-middle" >Başlangıç Tarihi</th>
      <th scope="col" class="text-center align-middle">Bitiş Tarihi</th>
      <th scope="col" class="text-center align-middle">KDV Hariç Tutar</th>
      <th scope="col" class="text-center align-middle">KDV Oranı</th>
      <th scope="col" class="text-center align-middle">KDV Dahil Tutar</th>
      <th scope="col" class="text-center align-middle">Ödeme Tarihi</th>
      <th scope="col" class="text-center align-middle">Ödeme Yöntemi</th>
      <th scope="col" class="text-center align-middle">Not</th>  <!-- Yeni sütun -->
      <th scope="col" class="text-center align-middle">Email Gönder</th>
      <th scope="col" class="text-center align-middle">Dosya</th>
    </tr>
  </thead>
  <tbody>
    <% @payment_tables.order(:id).each_with_index do |payment, index| %>
      <tr id="payment_row_<%= payment.id %>">
        <td class="text-center align-middle"><%= index + 1 %></td>
        <td class="text-center align-middle"><%= payment.rent_table_quantity %></td>
        <td class="text-center align-middle">
          <%= l(payment.start_date) %>
          <% unless payment.file.attached? %>
            <% if payment.start_date < Date.current %>
              <span class="badge bg-danger ms-2">GECİKTİ</span>
            <% end %>
          <% end %>
        </td>
        <td class="text-center align-middle"><%= l(payment.end_date) %></td>
        <td class="text-center align-middle"><%= number_to_currency(payment.amount_excluding_vat, precision: 2) %></td>
        <td class="text-center align-middle"><%= payment.vat_percentage %>%</td>
        <td class="text-center align-middle"><%= number_to_currency(payment.amount_including_vat) %></td>
        <td class="text-center align-middle"><%= payment.payment_date %></td>
        <td class="text-center align-middle">
          <%= form_with(model: payment, local: true) do |form| %>
            <%= form.collection_select :payment_method_id,
                PaymentMethod.order(:payment_method),
                :id,
                :payment_method,
                { include_blank: "-" },
                { 
                  class: "form-select form-select-sm",
                  style: "width: auto; display: inline-block;",
                  onchange: 'this.form.requestSubmit()'
                } 
            %>
          <% end %>
        </td>

        <td class="text-center align-middle" style="min-width: 200px;">
          <%= form_with(model: payment, local: true) do |form| %>
            <div class="input-group input-group-sm">
              <%= form.text_area :note, 
                  class: 'form-control form-control-sm', 
                  rows: 2,
                  placeholder: 'Not ekleyin...' %>
              <%= form.submit 'Kaydet', 
                  class: 'btn btn-sm btn-success',
                  tyle: 'height: 25px; font-size: 12px; padding: 0 8px; margin-left: 5px; align-self: flex-end;' %>
            </div>
          <% end %>
        </td>

        <td class="text-center align-middle">
          <% if payment.email_sent_at.present? %>
            <span class="badge bg-success">
              <i class="material-icons">check</i>
              Email Gönderildi
              <small>(<%= payment.email_sent_at.strftime("%d.%m.%Y %H:%M") %>)</small>
            </span>
          <% else %>
            <%= button_to send_payment_email_payment_table_path(payment),
                method: :post,
                class: "btn btn-sm btn-info",
                data: { confirm: "Bu ödeme için email göndermek istediğinize emin misiniz?" } do %>
              <i class="material-icons">email</i>
              Email Gönder
            <% end %>
          <% end %>
        </td> 
                
        <td class="text-center align-middle" style="width: 200px;">
          <div class="btn-group">
            <% if payment.file.attached? %>
              <%= link_to rails_blob_path(payment.file, disposition: "attachment"), 
                  class: "btn btn-sm btn-info", 
                  title: payment.file.filename.to_s,
                  data: { bs_toggle: "tooltip" } do %>
                <span class="material-icons">download</span>
              <% end %>
              
              <%= button_to delete_file_payment_table_path(payment), 
                  method: :delete,
                  form: { 
                    style: 'display: inline-block;',
                    data: { confirm: "Dosyayı silmek istediğinize emin misiniz?" }
                  },
                  class: "btn btn-sm btn-danger",
                  title: "Dosyayı Sil" do %>
                <span class="material-icons">delete</span>
              <% end %>
            <% end %>
            
            <%= button_tag type: "button", 
                class: "btn btn-sm btn-primary", 
                data: { bs_toggle: "modal", bs_target: "#uploadModal#{payment.id}" } do %>
              
              <% if payment.file.attached? %>
              <span class="material-icons">upload</span>
                
              <% else %>
                <span class="material-icons">upload</span>
                <span>Yükle</span>
              <% end %>
            <% end %>
          </div>

          <!-- Modal -->
          <div class="modal fade" id="uploadModal<%= payment.id %>" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Dosya Yükle</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <%= form_with(model: payment, local: true, multipart: true) do |form| %>
                    <div class="mb-3">
                      <% if payment.file.attached? %>
                        <p class="text-muted">Mevcut dosya: <%= payment.file.filename %></p>
                      <% end %>
                      <%= form.file_field :file, 
                          class: "form-control form-control-sm",
                          accept: ".pdf,.doc,.docx,.xls,.xlsx" %>
                    </div>
                    <div class="text-end">
                      <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">İptal</button>
                      <%= form.submit "Yükle", class: "btn btn-primary btn-sm" %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </td>

          

       
      </tr>
    <% end %>
  </tbody>
</table>

</div>
